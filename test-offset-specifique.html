<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test des Offsets Sp√©cifiques -126ms et +320ms</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .test-case.scenario-1 {
            border-left: 4px solid #ff5722;
        }
        .test-case.scenario-2 {
            border-left: 4px solid #2196f3;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .explanation {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test des Offsets Sp√©cifiques TimeService</h1>
        <p>Ce test v√©rifie la logique sp√©cifique pour les cas d'offset -126ms et +320ms selon vos sp√©cifications.</p>
        
        <div class="explanation">
            <strong>Logique Impl√©ment√©e :</strong><br>
            ‚Ä¢ <strong>Mode EN LIGNE</strong> ‚Üí Utiliser l'offset normal du serveur (pas de correction sp√©ciale)<br>
            ‚Ä¢ <strong>Mode HORS CONNEXION + offset -126ms</strong> ‚Üí Appliquer correction +126ms au temps local<br>
            ‚Ä¢ <strong>Mode HORS CONNEXION + offset +320ms</strong> ‚Üí Appliquer correction -320ms au temps local<br>
            ‚Ä¢ <strong>Mode HORS CONNEXION + autres offsets</strong> ‚Üí Appliquer l'offset normal
        </div>
    </div>

    <div class="container">
        <h2>üß™ Tests de Simulation</h2>
        
        <div class="test-case scenario-1">
            <h3>Sc√©nario 1: Mode HORS CONNEXION avec offset -126ms</h3>
            <p><strong>Situation :</strong> Impossible de se connecter au serveur + offset sauv√© -126ms</p>
            <p><strong>Correction attendue :</strong> Ajouter 126ms au temps local ‚Üí offset appliqu√© +126ms</p>
            <button class="button" onclick="simulateOfflineMode(-126)">Simuler hors connexion avec -126ms</button>
        </div>

        <div class="test-case scenario-2">
            <h3>Sc√©nario 2: Mode HORS CONNEXION avec offset +320ms</h3>
            <p><strong>Situation :</strong> Impossible de se connecter au serveur + offset sauv√© +320ms</p>
            <p><strong>Correction attendue :</strong> Retrancher 320ms du temps local ‚Üí offset appliqu√© -320ms</p>
            <button class="button" onclick="simulateOfflineMode(320)">Simuler hors connexion avec +320ms</button>
        </div>

        <div class="test-case">
            <h3>Test Mode EN LIGNE: Offset quelconque</h3>
            <p><strong>Situation :</strong> Connexion serveur r√©ussie avec offset (ex: -126ms ou +320ms)</p>
            <p><strong>Correction attendue :</strong> Utiliser l'offset normal (pas de correction sp√©ciale)</p>
            <button class="button" onclick="simulateOnlineMode(-126)">Simuler en ligne avec -126ms</button>
            <button class="button" onclick="simulateOnlineMode(320)">Simuler en ligne avec +320ms</button>
        </div>
    </div>

    <div class="container">
        <h2>üìã R√©sultats des Tests</h2>
        <div id="results"></div>
        <button class="button danger" onclick="clearResults()">Effacer les r√©sultats</button>
    </div>

    <div class="container">
        <h2>üìä Tableau de V√©rification</h2>
        <table>
            <thead>
                <tr>
                    <th>Offset Mesur√©</th>
                    <th>Signification</th>
                    <th>Correction Appliqu√©e</th>
                    <th>R√©sultat Final</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: #e8f5e8;">
                    <td>EN LIGNE</td>
                    <td>Connexion serveur OK</td>
                    <td>Offset normal (aucune correction)</td>
                    <td>Synchronisation standard</td>
                </tr>
                <tr style="background: #ffebee;">
                    <td>HORS CONNEXION + (-126ms)</td>
                    <td>Pas de connexion + offset -126ms</td>
                    <td>+126ms au temps local</td>
                    <td>Compensation de l'avance locale</td>
                </tr>
                <tr style="background: #e3f2fd;">
                    <td>HORS CONNEXION + (+320ms)</td>
                    <td>Pas de connexion + offset +320ms</td>
                    <td>-320ms du temps local</td>
                    <td>Compensation du retard local</td>
                </tr>
                <tr>
                    <td>HORS CONNEXION + autres</td>
                    <td>Pas de connexion + offset normal</td>
                    <td>Offset normal</td>
                    <td>Utilisation offset sauv√©</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="container">
        <h2>üîß Test avec LocalStorage</h2>
        <p>Simuler le chargement d'offsets depuis localStorage :</p>
        <button class="button" onclick="testLocalStorageOffset(-126)">Charger offset -126ms depuis localStorage</button>
        <button class="button" onclick="testLocalStorageOffset(320)">Charger offset +320ms depuis localStorage</button>
        <button class="button danger" onclick="clearLocalStorage()">Effacer localStorage</button>
    </div>

    <div class="container">
        <h2>üìù Log des Op√©rations</h2>
        <div id="log" class="log">Pr√™t pour les tests...\n</div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 12);
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addResult(type, title, message) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            log('R√©sultats effac√©s');
        }

        function clearLocalStorage() {
            localStorage.removeItem('time_manager_offset');
            localStorage.removeItem('time_manager_last_sync');
            log('LocalStorage effac√©');
            addResult('info', 'LocalStorage', 'Donn√©es effac√©es');
        }

        // Simulation de la logique sp√©cifique UNIQUEMENT en mode hors connexion
        function applySpecificOffsetLogicOffline(originalOffset) {
            if (originalOffset === -126) {
                log(`üéØ MODE HORS CONNEXION: Cas sp√©cial UTC -126ms ‚Üí Ajout de 126ms au temps local`);
                return 126;
            }
            
            if (originalOffset === 320) {
                log(`üéØ MODE HORS CONNEXION: Cas sp√©cial UTC +320ms ‚Üí Retrait de 320ms du temps local`);
                return -320;
            }
            
            log(`üìä MODE HORS CONNEXION: Offset normal appliqu√©: ${originalOffset}ms`);
            return originalOffset;
        }

        function simulateOnlineMode(measuredOffset) {
            log(`\nüåê === MODE EN LIGNE - OFFSET ${measuredOffset}ms ===`);
            log(`üì° Connexion serveur r√©ussie`);
            log(`üìä Offset mesur√© depuis serveur: ${measuredOffset}ms`);
            
            // En ligne : utiliser l'offset normal (pas de correction sp√©ciale)
            const appliedOffset = measuredOffset;
            
            log(`‚öôÔ∏è Offset appliqu√©: ${appliedOffset}ms (normal, pas de correction)`);
            
            const now = Date.now();
            const localTime = new Date(now);
            const correctedTime = new Date(now + appliedOffset);
            
            log(`‚è∞ Heure locale brute: ${localTime.toISOString()}`);
            log(`üéØ Heure corrig√©e (locale + offset): ${correctedTime.toISOString()}`);
            log(`üåê Mode en ligne: utilisation offset normal ${appliedOffset}ms`);
            
            // Sauvegarder pour usage hors ligne futur
            localStorage.setItem('time_manager_offset', measuredOffset.toString());
            localStorage.setItem('time_manager_last_sync', Date.now().toString());
            log(`üíæ Offset ${measuredOffset}ms sauvegard√© pour usage hors connexion futur`);
            
            addResult('success', `Mode EN LIGNE ${measuredOffset}ms`, 
                     `‚úÖ Offset normal appliqu√©: ${appliedOffset}ms (pas de correction sp√©ciale)`);
        }

        function simulateOfflineMode(savedOffset) {
            log(`\nüì± === MODE HORS CONNEXION - OFFSET ${savedOffset}ms ===`);
            log(`‚ùå Impossible de se connecter au serveur`);
            log(`üì± Chargement offset sauv√©: ${savedOffset}ms`);
            
            const appliedOffset = applySpecificOffsetLogicOffline(savedOffset);
            
            log(`‚öôÔ∏è Offset appliqu√© en hors connexion: ${appliedOffset}ms`);
            
            const now = Date.now();
            const localTime = new Date(now);
            const correctedTime = new Date(now + appliedOffset);
            
            log(`‚è∞ Heure locale brute: ${localTime.toISOString()}`);
            log(`üéØ Heure corrig√©e (locale + offset): ${correctedTime.toISOString()}`);
            
            if (savedOffset !== appliedOffset) {
                log(`ÔøΩ HORS CONNEXION: Offset corrig√© ${savedOffset}ms ‚Üí ${appliedOffset}ms`);
            } else {
                log(`üìä HORS CONNEXION: Offset normal utilis√© ${appliedOffset}ms`);
            }
            
            // R√©sultat du test
            let testResult;
            let resultType;
            
            if (savedOffset === -126 && appliedOffset === 126) {
                testResult = '‚úÖ SUCC√àS: Mode hors connexion avec -126ms ‚Üí correction +126ms';
                resultType = 'success';
            } else if (savedOffset === 320 && appliedOffset === -320) {
                testResult = '‚úÖ SUCC√àS: Mode hors connexion avec +320ms ‚Üí correction -320ms';
                resultType = 'success';
            } else if (savedOffset === appliedOffset && savedOffset !== -126 && savedOffset !== 320) {
                testResult = '‚úÖ SUCC√àS: Mode hors connexion avec offset normal';
                resultType = 'success';
            } else {
                testResult = '‚ùå ERREUR: Logique hors connexion incorrecte';
                resultType = 'error';
            }
            
            log(testResult);
            addResult(resultType, `Mode HORS CONNEXION ${savedOffset}ms`, testResult);
        }

        function simulateOffset(measuredOffset) {
            // Fonction legacy - rediriger vers les nouveaux tests
            log(`\n‚ö†Ô∏è === REDIRECTION VERS NOUVEAUX TESTS ===`);
            log(`Cette fonction est obsol√®te. Utilisez les nouveaux tests:`);
            log(`- Mode EN LIGNE: simulateOnlineMode(${measuredOffset})`);
            log(`- Mode HORS CONNEXION: simulateOfflineMode(${measuredOffset})`);
            
            addResult('info', 'Test Legacy', 'Utilisez les nouveaux boutons de test EN LIGNE / HORS CONNEXION');
        }

        function testLocalStorageOffset(savedOffset) {
            log(`\nüì± === TEST CHARGEMENT LOCALSTORAGE ${savedOffset}ms ===`);
            
            // Simuler des donn√©es dans localStorage
            localStorage.setItem('time_manager_offset', savedOffset.toString());
            localStorage.setItem('time_manager_last_sync', Date.now().toString());
            
            log(`üì± Simulation: offset ${savedOffset}ms trouv√© dans localStorage`);
            
            const appliedOffset = applySpecificOffsetLogic(savedOffset);
            
            log(`‚öôÔ∏è Offset appliqu√© au d√©marrage: ${appliedOffset}ms`);
            
            if (savedOffset !== appliedOffset) {
                log(`üîÑ Transformation: ${savedOffset}ms ‚Üí ${appliedOffset}ms`);
                addResult('info', `Chargement localStorage ${savedOffset}ms`, 
                         `Offset transform√© de ${savedOffset}ms en ${appliedOffset}ms`);
            } else {
                log(`üìä Aucune transformation n√©cessaire`);
                addResult('info', `Chargement localStorage ${savedOffset}ms`, 
                         `Offset appliqu√© directement: ${appliedOffset}ms`);
            }
        }

        // Test automatique au chargement
        window.onload = function() {
            log('üöÄ Page de test charg√©e');
            log('üìã Tests disponibles pour les offsets sp√©cifiques -126ms et +320ms');
            addResult('info', 'Initialisation', 'Page de test pr√™te. Utilisez les boutons pour tester la logique.');
        };
    </script>
</body>
</html>
