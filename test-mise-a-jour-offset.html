<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mise √† Jour Offset au D√©marrage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .startup {
            border-left: 4px solid #4CAF50;
        }
        .refresh {
            border-left: 4px solid #2196F3;
        }
        .periodic {
            border-left: 4px solid #FF9800;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.refresh {
            background: #2196F3;
        }
        .button.refresh:hover {
            background: #1976D2;
        }
        .button.periodic {
            background: #FF9800;
        }
        .button.periodic:hover {
            background: #F57C00;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .status-item {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 150px;
            text-align: center;
        }
        .status-item.online {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .status-item.offline {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Test Mise √† Jour Offset - D√©marrage, Refresh et P√©riodique</h1>
        <p>Ce test v√©rifie que l'offset est correctement mis √† jour et sauv√© en m√©moire lors de :</p>
        <ul>
            <li><strong>D√©marrage du t√©l√©phone/application</strong></li>
            <li><strong>R√©initialisation de la page (refresh)</strong></li>
            <li><strong>Synchronisations p√©riodiques</strong></li>
        </ul>
    </div>

    <div class="container">
        <h2>üìä √âtat Actuel</h2>
        <div class="status">
            <div class="status-item" id="connection-status">
                <strong>Connexion</strong><br>
                <span id="connection-text">Non test√©</span>
            </div>
            <div class="status-item" id="offset-status">
                <strong>Offset Sauv√©</strong><br>
                <span id="offset-text">Non v√©rifi√©</span>
            </div>
            <div class="status-item" id="sync-status">
                <strong>Derni√®re Sync</strong><br>
                <span id="sync-text">Jamais</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üß™ Tests de Simulation</h2>
        
        <div class="test-case startup">
            <h3>1. Simulation D√©marrage Application</h3>
            <p>Simule le d√©marrage de l'application avec initialisation compl√®te du TimeService</p>
            <button class="button" onclick="simulateAppStartup()">üöÄ Simuler D√©marrage App</button>
        </div>

        <div class="test-case refresh">
            <h3>2. Simulation Refresh/R√©initialisation</h3>
            <p>Simule une r√©initialisation de page avec arr√™t et red√©marrage des services</p>
            <button class="button refresh" onclick="simulatePageRefresh()">üîÑ Simuler Refresh Page</button>
        </div>

        <div class="test-case periodic">
            <h3>3. Simulation Sync P√©riodique</h3>
            <p>Simule une synchronisation p√©riodique automatique (toutes les 15 minutes)</p>
            <button class="button periodic" onclick="simulatePeriodicSync()">‚è∞ Simuler Sync P√©riodique</button>
        </div>
    </div>

    <div class="container">
        <h2>üìã V√©rification LocalStorage</h2>
        <button class="button" onclick="checkLocalStorage()">üîç V√©rifier Offset Sauv√©</button>
        <button class="button" onclick="clearLocalStorage()">üóëÔ∏è Effacer LocalStorage</button>
        <button class="button" onclick="setTestOffset()">üß™ D√©finir Offset Test</button>
        
        <table id="storage-table" style="margin-top: 15px; display: none;">
            <thead>
                <tr>
                    <th>Cl√©</th>
                    <th>Valeur</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="storage-tbody">
            </tbody>
        </table>
    </div>

    <div class="container">
        <h2>üìà Historique des Mises √† Jour</h2>
        <div id="results"></div>
        <button class="button" onclick="clearResults()" style="background: #f44336;">Effacer Historique</button>
    </div>

    <div class="container">
        <h2>üìù Log D√©taill√©</h2>
        <div id="log" class="log">Pr√™t pour les tests de mise √† jour d'offset...\n</div>
    </div>

    <script>
        let simulatedOffset = null;
        let simulatedConnectionStatus = true;
        let updateCounter = 0;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 12);
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addResult(type, title, message) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function updateStatus() {
            // Mise √† jour du statut de connexion
            const connectionEl = document.getElementById('connection-status');
            const connectionText = document.getElementById('connection-text');
            if (simulatedConnectionStatus) {
                connectionEl.className = 'status-item online';
                connectionText.textContent = 'En ligne';
            } else {
                connectionEl.className = 'status-item offline';
                connectionText.textContent = 'Hors ligne';
            }

            // Mise √† jour de l'offset
            const offsetText = document.getElementById('offset-text');
            const savedOffset = localStorage.getItem('time_manager_offset');
            offsetText.textContent = savedOffset ? `${savedOffset}ms` : 'Aucun';

            // Mise √† jour de la derni√®re sync
            const syncText = document.getElementById('sync-text');
            const lastSync = localStorage.getItem('time_manager_last_sync');
            if (lastSync) {
                const syncTime = new Date(parseInt(lastSync));
                syncText.textContent = syncTime.toLocaleTimeString();
            } else {
                syncText.textContent = 'Jamais';
            }
        }

        function simulateServerSync() {
            if (!simulatedConnectionStatus) {
                log('‚ùå Simulation: Connexion serveur √©chou√©e (mode hors ligne)');
                return null;
            }

            // Simuler diff√©rents offsets pour les tests
            const possibleOffsets = [-126, 320, 50, -75, 100, -200];
            const randomOffset = possibleOffsets[Math.floor(Math.random() * possibleOffsets.length)];
            
            log(`üì° Simulation: Connexion serveur r√©ussie`);
            log(`üìä Simulation: Offset mesur√© depuis serveur: ${randomOffset}ms`);
            
            return randomOffset;
        }

        function simulateAppStartup() {
            updateCounter++;
            log(`\nüöÄ === SIMULATION D√âMARRAGE APPLICATION #${updateCounter} ===`);
            log('üì± D√©marrage d√©tect√© - mise √† jour obligatoire de l\'offset');
            
            // 1. Chargement offset sauv√©
            const savedOffset = localStorage.getItem('time_manager_offset');
            if (savedOffset) {
                log(`üì± Offset charg√© depuis la m√©moire: ${savedOffset}ms (pour fallback)`);
            } else {
                log('üì± Aucun offset sauvegard√© trouv√© - premi√®re utilisation');
            }

            // 2. Tentative de synchronisation obligatoire
            log('üîÑ Mise √† jour obligatoire de l\'offset au d√©marrage...');
            const newOffset = simulateServerSync();
            
            if (newOffset !== null) {
                // Mode en ligne
                simulatedOffset = newOffset;
                localStorage.setItem('time_manager_offset', newOffset.toString());
                localStorage.setItem('time_manager_last_sync', Date.now().toString());
                
                log(`‚úÖ CONNEXION R√âUSSIE: Offset mis √† jour: ${newOffset}ms`);
                log(`üíæ Offset sauvegard√© en m√©moire du t√©l√©phone`);
                log(`üåê Mode en ligne: utilisation offset normal ${newOffset}ms`);
                
                addResult('success', `D√©marrage #${updateCounter}`, 
                         `‚úÖ Offset mis √† jour et sauv√©: ${newOffset}ms (mode en ligne)`);
            } else {
                // Mode hors ligne
                if (savedOffset) {
                    const originalOffset = parseInt(savedOffset);
                    let correctedOffset = originalOffset;
                    
                    // Appliquer logique sp√©cifique si hors connexion
                    if (originalOffset === -126) {
                        correctedOffset = 126;
                        log('üéØ MODE HORS CONNEXION: Cas sp√©cial UTC -126ms ‚Üí Ajout de 126ms au temps local');
                    } else if (originalOffset === 320) {
                        correctedOffset = -320;
                        log('üéØ MODE HORS CONNEXION: Cas sp√©cial UTC +320ms ‚Üí Retrait de 320ms du temps local');
                    } else {
                        log(`üìä MODE HORS CONNEXION: Offset normal appliqu√©: ${originalOffset}ms`);
                    }
                    
                    simulatedOffset = correctedOffset;
                    log(`üì± HORS CONNEXION: Utilisation offset ${correctedOffset}ms`);
                    
                    addResult('info', `D√©marrage #${updateCounter}`, 
                             `üì± Mode hors connexion: offset ${correctedOffset}ms (sauv√©: ${originalOffset}ms)`);
                } else {
                    log('üì± HORS CONNEXION: Aucun offset disponible, heure locale utilis√©e');
                    addResult('info', `D√©marrage #${updateCounter}`, 
                             'üì± Mode hors connexion: aucun offset disponible');
                }
            }

            log('‚úÖ Service de temps initialis√© avec offset mis √† jour');
            updateStatus();
        }

        function simulatePageRefresh() {
            updateCounter++;
            log(`\nüîÑ === SIMULATION REFRESH PAGE #${updateCounter} ===`);
            log('üì± R√©initialisation de la page d√©tect√©e - mise √† jour obligatoire de l\'offset');
            
            // Arr√™t des services existants
            log('üõë Arr√™t des timers de synchronisation existants...');
            log('üîÑ R√©initialisation compl√®te du TimeService...');
            
            // R√©initialisation compl√®te (comme un d√©marrage)
            simulateAppStartup();
            
            addResult('info', `Refresh #${updateCounter}`, 
                     'üîÑ Page rafra√Æchie avec r√©initialisation compl√®te du TimeService');
        }

        function simulatePeriodicSync() {
            updateCounter++;
            log(`\n‚è∞ === SYNCHRONISATION P√âRIODIQUE #${updateCounter} ===`);
            log('üîÑ Synchronisation p√©riodique en cours - mise √† jour offset...');
            
            const newOffset = simulateServerSync();
            
            if (newOffset !== null) {
                // Mode en ligne
                const oldOffset = simulatedOffset;
                simulatedOffset = newOffset;
                
                localStorage.setItem('time_manager_offset', newOffset.toString());
                localStorage.setItem('time_manager_last_sync', Date.now().toString());
                
                if (oldOffset !== null) {
                    const drift = newOffset - oldOffset;
                    log(`üîÑ Offset mis √† jour: ${oldOffset}ms ‚Üí ${newOffset}ms (d√©rive: ${drift}ms)`);
                } else {
                    log(`‚úÖ Premier offset √©tabli: ${newOffset}ms`);
                }
                
                log(`üíæ Offset mis √† jour et sauv√© en m√©moire: ${newOffset}ms`);
                
                addResult('success', `Sync P√©riodique #${updateCounter}`, 
                         `‚úÖ Offset mis √† jour: ${newOffset}ms (sauv√© en m√©moire)`);
            } else {
                log('üì± Synchronisation p√©riodique √©chou√©e - conservation offset existant');
                addResult('info', `Sync P√©riodique #${updateCounter}`, 
                         'üì± Synchronisation √©chou√©e - offset conserv√©');
            }
            
            updateStatus();
        }

        function checkLocalStorage() {
            log('\nüîç === V√âRIFICATION LOCALSTORAGE ===');
            
            const table = document.getElementById('storage-table');
            const tbody = document.getElementById('storage-tbody');
            tbody.innerHTML = '';
            
            const keys = ['time_manager_offset', 'time_manager_last_sync'];
            let hasData = false;
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    hasData = true;
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = key;
                    
                    if (key === 'time_manager_last_sync') {
                        const date = new Date(parseInt(value));
                        row.insertCell(1).textContent = `${value} (${date.toLocaleString()})`;
                    } else {
                        row.insertCell(1).textContent = value;
                    }
                    
                    row.insertCell(2).textContent = key === 'time_manager_offset' ? 'Offset en millisecondes' : 'Timestamp derni√®re sync';
                    
                    log(`üì± ${key}: ${value}`);
                }
            });
            
            if (hasData) {
                table.style.display = 'table';
                addResult('info', 'V√©rification LocalStorage', 'Donn√©es trouv√©es - voir tableau');
            } else {
                table.style.display = 'none';
                log('üì± Aucune donn√©e trouv√©e dans localStorage');
                addResult('info', 'V√©rification LocalStorage', 'Aucune donn√©e trouv√©e');
            }
            
            updateStatus();
        }

        function clearLocalStorage() {
            localStorage.removeItem('time_manager_offset');
            localStorage.removeItem('time_manager_last_sync');
            log('üóëÔ∏è LocalStorage effac√©');
            addResult('info', 'LocalStorage', 'Donn√©es effac√©es');
            updateStatus();
            
            const table = document.getElementById('storage-table');
            table.style.display = 'none';
        }

        function setTestOffset() {
            const testOffset = -126; // Utiliser un cas sp√©cial pour les tests
            localStorage.setItem('time_manager_offset', testOffset.toString());
            localStorage.setItem('time_manager_last_sync', Date.now().toString());
            log(`üß™ Offset de test d√©fini: ${testOffset}ms`);
            addResult('info', 'Offset Test', `Offset d√©fini: ${testOffset}ms`);
            updateStatus();
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            log('üóëÔ∏è Historique des r√©sultats effac√©');
        }

        // Contr√¥les de connexion
        function toggleConnection() {
            simulatedConnectionStatus = !simulatedConnectionStatus;
            log(`üîÑ Mode de connexion chang√©: ${simulatedConnectionStatus ? 'EN LIGNE' : 'HORS LIGNE'}`);
            updateStatus();
        }

        // Initialisation
        window.onload = function() {
            log('üöÄ Page de test charg√©e');
            log('üìã Tests disponibles pour v√©rifier la mise √† jour d\'offset');
            updateStatus();
            
            // Ajouter bouton de contr√¥le de connexion
            const container = document.querySelector('.container');
            const connectionControl = document.createElement('div');
            connectionControl.innerHTML = `
                <h3>üåê Contr√¥le de Connexion</h3>
                <button class="button" onclick="toggleConnection()">üîÑ Basculer Mode Connexion</button>
                <p><em>Mode actuel: <span id="mode-indicator">En ligne</span></em></p>
            `;
            container.appendChild(connectionControl);
            
            addResult('info', 'Initialisation', 'Page de test pr√™te. Testez les diff√©rents sc√©narios de mise √† jour d\'offset.');
        };
    </script>
</body>
</html>
